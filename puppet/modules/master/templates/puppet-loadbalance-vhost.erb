#	<Proxy balancer://puppetmaster>
#		BalancerMember http://localhost:<%= @master_port %>
#		BalancerMember http://master1.coetzee.com:8140
#		BalancerMember http://master2.coetzee.com:8140
#	</Proxy>
	
	Listen <%= @balancer_port %>
	<VirtualHost *:<%= @balancer_port %>>
	    SSLEngine On
	
	    # Only allow high security cryptography. Alter if needed for compatibility.
	    SSLProtocol             All -SSLv2
	    # SSLCipherSuite SSLv2:-LOW:-EXPORT:RC4+RSA
	    SSLCipherSuite          HIGH:!ADH:RC4+RSA:-MEDIUM:-LOW:-EXP
	    #SSLCipherSuite 			ALL:!ADH:RC4+RSA:+HIGH:+MEDIUM:-LOW:-SSLv2:-EXP
	    SSLCertificateFile      /var/lib/puppet/ssl/certs/<%= @fqdn %>.pem
	    SSLCertificateKeyFile   /var/lib/puppet/ssl/private_keys/<%= @fqdn %>.pem
	    SSLCertificateChainFile /var/lib/puppet/ssl/ca/ca_crt.pem
	    SSLCACertificateFile    /var/lib/puppet/ssl/ca/ca_crt.pem
	    SSLCARevocationFile     /var/lib/puppet/ssl/ca/ca_crl.pem
	    #SSLCARevocationCheck 	chain
	    SSLVerifyClient         optional
	    SSLVerifyDepth          1
	    SSLOptions              +StdEnvVars +ExportCertData
	    
	    # Apache 2.4 introduces the SSLCARevocationCheck directive and sets it to none
		# which effectively disables CRL checking. If you are using Apache 2.4+ you must
	    # specify 'SSLCARevocationCheck chain' to actually use the CRL.
	
	    # These request headers are used to pass the client certificate
	    # authentication information on to the puppet master process
	    RequestHeader set X-SSL-Subject %{SSL_CLIENT_S_DN}e
	    RequestHeader set X-Client-DN %{SSL_CLIENT_S_DN}e
	    RequestHeader set X-Client-Verify %{SSL_CLIENT_VERIFY}e
	
		<Location />
			SetHandler balancer-manager
			Order allow,deny
			Allow from all
		</Location>

		ProxyPass / balancer://puppetmaster/
		ProxyPassReverse / balancer://puppetmaster/
		ProxyPreserveHost On
	
	    ErrorLog /var/log/httpd/<%= @fqdn %>_balancer_error.log
	    CustomLog /var/log/httpd/<%= @fqdn %>_balancer_access.log combined
	    CustomLog /var/log/httpd/balancer_ssl_requests.log "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"
	</VirtualHost>
